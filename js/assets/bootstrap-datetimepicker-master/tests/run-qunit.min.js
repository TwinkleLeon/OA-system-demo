function waitFor(testFx,onReady,timeOutMillis){var maxtimeOutMillis=timeOutMillis?timeOutMillis:10001,start=(new Date).getTime(),condition=!1,interval=setInterval(function(){(new Date).getTime()-start<maxtimeOutMillis&&!condition?condition="string"==typeof testFx?eval(testFx):testFx():condition?("string"==typeof onReady?eval(onReady):onReady(),clearInterval(interval)):(console.log("'waitFor()' timeout"),phantom.exit(1))},100)}function readFileLines(e){for(var t=fs.open(e,"r"),n=[];!t.atEnd();)n.push(t.readLine());return t.close(),n}var system=require("system");2!==system.args.length&&(console.log("Usage: run-qunit.js URL"),phantom.exit(1));var fs=require("fs"),page=require("webpage").create();page.onConsoleMessage=function(e){console.log(e)},page.onError=function(e,t){console.log(e),t.forEach(function(e){console.log("  ",e.file,":",e.line)})};var _openPath=phantom.args[0].replace(/^.*(\\|\/)/,""),openPath=_openPath,origdir="../js/",basedir="../instrumented/",coverageBase=fs.read("_coverage.html");if(fs.exists(basedir)){for(var script=/<script.*><\/script>/g,src=/src=(["'])(.*?)\1/,contents=fs.read(openPath),_contents=contents,srcs=[],s;script.exec(contents);)s=src.exec(RegExp.lastMatch)[2],s&&-1!=s.indexOf(origdir)&&(_contents=_contents.replace(s,s.replace(origdir,basedir)));_contents!=contents&&(openPath+=".cov.html",fs.write(openPath,_contents))}page.open(openPath,function(e){if("success"!==e)console.log("Unable to access network"),phantom.exit(1);else{if(fs.exists(basedir))for(var t=0;t<srcs.length;t++)page.includeJs(srcs[t]);waitFor(function(){return page.evaluate(function(){var e=document.getElementById("qunit-testresult");return e&&e.innerText.match("completed")?!0:!1})},function(){var e=JSON.parse(page.evaluate(function(){return JSON.stringify(getCoverageByLine())}));if(e.key){for(var t=e.lines,n=origdir+fs.separator+e.key,r=e.source,s=readFileLines(n),o="",a=0;a<t.length;a++){var i=t[a+1],c="";c="number"==typeof i?" "+(i>0?"hit":"miss"):" undef";var l=s[a];r||(l=l.replace("<","&lt;").replace(">","&gt;")),o+='<div class="code'+c+'">'+l+"</div>\n"}o=coverageBase.replace("COLORIZED_LINE_HTML",o),fs.write("coverage.html",o,"w"),console.log("Coverage for "+e.key+" in coverage.html")}_openPath!=openPath&&fs.remove(openPath);var g=page.evaluate(function(){var e=document.getElementById("qunit-testresult");console.log(e.innerText);try{return e.getElementsByClassName("failed")[0].innerHTML}catch(t){}return 1e4});phantom.exit(parseInt(g,10)>0?1:0)})}});